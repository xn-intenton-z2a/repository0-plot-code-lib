# repository0-plot-code-lib

_"Be a go-to plot library with a CLI, be the jq of formulae visualisations."_

---

## Usage

### CLI

The CLI now requires three parameters: --expression, --range, and --file. Additional optional flags include --evaluate, --diagnostics, --color, --stroke, --width, --height, --padding, --samples, --grid, --marker, and the new --no-legend flag.

- --expression: A non-empty string representing one or more mathematical expressions. For a single expression, use the format (e.g., "y=sin(x)"). For multiple expressions, separate them with a semicolon (e.g., "y=sin(x);y=cos(x)"). In each expression, if the string starts with "y=", the prefix is removed and basic math functions (like sin, cos, tan, sqrt, log, exp) are translated for JavaScript evaluation.
- --range: A string specifying the range for the x-axis and optionally the y-axis. It can be provided in the format 'x=min:max' or 'x=min:max,y=min:max'. When a y-range is provided, its boundaries will be used for plotting rather than auto scaling based on computed values.
- --file: The output file name which must end with .svg, .png, or .csv. When a .png file is specified, the generated SVG plot is converted to PNG using the sharp library. When a .csv file is specified, the computed time series data is exported in CSV format. Note: CSV export does not support multiple expressions; attempting to export multiple expressions as CSV will result in an error.
- --evaluate: (Optional) When provided, the CLI evaluates the given expression(s) over the x-range, generates time series data and outputs it in JSON format in the console (except when exporting CSV).
- --diagnostics: (Optional) When provided, the CLI outputs diagnostic details including the raw parsed CLI arguments before proceeding with validation. This aids in debugging.
- --color: (Optional) A valid CSS color string (e.g., 'red', '#FF0000'). For single expression plots, this sets the stroke color. For multiple expressions, if a color is provided, it is used for all curves; if not, a default palette (e.g., black, red, blue, etc.) is applied to distinguish each curve.
- --stroke: (Optional) A positive number representing the stroke width of the plot. Defaults to 2 if not provided.
- --width: (Optional) A positive integer to specify the canvas width of the generated plot. Defaults to 500 if not provided.
- --height: (Optional) A positive integer to specify the canvas height of the generated plot. Defaults to 500 if not provided.
- --padding: (Optional) A positive integer to set the padding within the canvas, affecting the plot margins. Defaults to 20 if not provided.
- --samples: (Optional) A positive integer specifying the number of sample points to generate the plot. Defaults to 100 if not provided.
- --grid: (Optional) When provided, gridlines are drawn on the plot. The gridlines are rendered in light gray (#ddd) with a stroke width of 1.
- --marker: (Optional) When provided, small circle markers (with a default radius of 3) are drawn at each computed data point using the stroke color.
- --no-legend: (Optional) When provided, the legend is disabled in multi-expression plots. By default a legend is generated if multiple expressions are provided.

#### New Legend Feature for Multiple Expressions

When multiple expressions are provided (separated by a semicolon) and the output is SVG or PNG, an SVG legend is generated by default. The legend is positioned in the top-right corner of the canvas and displays a color swatch along with the corresponding expression text for each curve, making it easier to distinguish between plots. Use the --no-legend flag to disable the legend.

#### Valid Usage Examples

Display help information:

```sh
node src/lib/main.js --help
# Output: Usage: node src/lib/main.js --expression <exp> --range <range> --file <filepath> [--evaluate] [--diagnostics] [--color <color>] [--stroke <number>] [--width <number>] [--height <number>] [--padding <number>] [--samples <number>] [--grid] [--marker] [--no-legend]
```

Run the CLI with a single expression (SVG plot generation):

```sh
node src/lib/main.js --expression "y=sin(x)" --range "x=-1:-1,y=-1:-1" --file output.svg
# Output:
# Validated arguments: {"expression":"y=sin(x)","range":"x=-1:-1,y=-1:-1","file":"output.svg"}
# Generating plot for expression: y=sin(x) with range: x=-1:-1,y=-1:-1
# Plot saved to output.svg
```

Run the CLI with multiple expressions (SVG plot generation with legend):

```sh
node src/lib/main.js --expression "y=sin(x);y=cos(x)" --range "x=0:10,y=-1:1" --file multi.svg
# Output:
# Validated arguments: {"expression":"y=sin(x);y=cos(x)","range":"x=0:10,y=-1:1","file":"multi.svg"}
# Generating plot for expression: y=sin(x);y=cos(x) with range: x=0:10,y=-1:1
# Plot saved to multi.svg
# The generated SVG includes a legend in the top-right corner showing the color swatch and label for each expression.
```

Run the CLI with multiple expressions and disable legend:

```sh
node src/lib/main.js --expression "y=sin(x);y=cos(x)" --range "x=0:10,y=-1:1" --file noLegend.svg --no-legend
# Output:
# Validated arguments: {"expression":"y=sin(x);y=cos(x)","range":"x=0:10,y=-1:1","file":"noLegend.svg","noLegend":true}
# Generating plot for expression: y=sin(x);y=cos(x) with range: x=0:10,y=-1:1
# Plot saved to noLegend.svg
# The generated SVG does not include a legend.
```

Run the CLI with PNG output (PNG plot generation):

```sh
node src/lib/main.js --expression "y=cos(x)" --range "x=0:10,y=0:5" --file output.png
# Output:
# Validated arguments: {"expression":"y=cos(x)","range":"x=0:10,y=0:5","file":"output.png"}
# Generating plot for expression: y=cos(x) with range: x=0:10,y=0:5
# Plot saved to output.png
```

Run the CLI with CSV export (only supports a single expression):

```sh
node src/lib/main.js --expression "y=sin(x)" --range "x=0:6,y=-1:1" --file output.csv
# Output:
# Validated arguments: {"expression":"y=sin(x)","range":"x=0:6,y=-1:1","file":"output.csv"}
# Time series CSV exported to output.csv
```

Attempting CSV export with multiple expressions:

```sh
node src/lib/main.js --expression "y=sin(x);y=cos(x)" --range "x=0:6,y=-1:1" --file output.csv
# Output:
# Error: CSV export does not support multiple expressions.
```

### Programmatic

You can also use the library programmatically:

```js
import { main } from "@src/lib/main.js";

main([
  "--expression", "y=sin(x);y=cos(x)",
  "--range", "x=0:6,y=-1:1",
  "--file", "output.svg", // or use output.png for PNG output or output.csv for CSV export (only one expression supported for CSV)
  "--evaluate",        // optional flag to output time series data (when not exporting CSV)
  "--diagnostics",     // optional flag to output diagnostic information
  "--color", "green", // optional flag to set the stroke color
  "--stroke", "3",    // optional flag to set the stroke width
  "--width", "800",   // optional custom canvas width
  "--height", "600",  // optional custom canvas height
  "--padding", "30",  // optional custom padding
  "--samples", "120", // optional custom sample count
  "--grid",            // optional flag to add gridlines
  "--marker",          // optional flag to add markers at data points
  "--no-legend"        // optional flag to disable the legend in multi-expression plots
]);
```

After successfully running the CLI with valid parameters, a plot is generated and saved to the specified file, or CSV data is exported if .csv is used. Note that CSV export supports only a single expression.
