# CUSTOM_FORMULAS Feature Specification

## Description
This feature introduces the ability for users to define and apply custom formulas to transform and derive new data columns from existing datasets before plotting. Users can write mathematical expressions or logical operations using a built-in expression parser (e.g., leveraging mathjs) to compute new metrics. These computed columns can be seamlessly integrated into the plotting commands via both CLI and the web interface, enhancing the analytical capability of our tool.

## Motivation
- **Enhanced Data Manipulation:** Empower users to derive meaningful insights by creating new data features on the fly.
- **Flexibility:** Provides a high degree of customization, allowing for transformations, aggregations, and even conditional operations.
- **Mission Alignment:** By streamlining the process of data transformation and visualization, this feature reinforces our goal of being the go-to plot library for formula-based visualisations.

## Implementation Details
1. **CLI Integration:**
   - Introduce a new CLI flag (e.g., `--formula`) that accepts custom formula expressions.
   - Allow users to reference existing data columns and use standard mathematical operators and functions.
   - Validate the expression using a library like mathjs, integrating it with the current numeric and token validation routines to ensure error-free execution.

2. **Web Interface Support:**
   - Add an interactive formula builder in the web interface where users can select columns, enter operations, and see real-time previews of the computed result.
   - Provide inline hints and error messages for malformed formulas, leveraging similar validation logic as the CLI.

3. **Data Processing Pipeline Enhancements:**
   - Modify the data import and filtering stage to incorporate computed columns generated by the custom formulas.
   - Ensure that the new data is merged with the original dataset and can be referenced in subsequent plotting commands.

4. **Testing and Documentation:**
   - Develop unit and integration tests to cover a variety of valid and invalid formula expressions.
   - Update the README and CONTRIBUTING documentation with examples and usage guidelines, ensuring consistency with other data transformation features.

## Usage
- **CLI Example:**
  ```bash
  node src/lib/main.js --import data.csv --formula "newCol=col1*2+col2" --plot "line:newCol,someOtherColumn,-10,10,1"
  ```

- **Web Interface Example:**
   - Launch the web server using `npm run start:web`.
   - Navigate to the data transformation section, use the formula builder to create new computed columns, and then select these columns for plotting.
