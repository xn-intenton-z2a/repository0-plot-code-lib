
You are providing the entire new content of source files, test files, documentation files, and other necessary
files with all necessary changes applied to deliver the resolution to an issue. Focus on high-impact, 
functional solutions that address core issues rather than superficial changes or excessive code polishing.
Implement as much as you can and refer to the projects features and mission statement when expanding the code
beyond the scope of the original issue. Implement whole features and do not leave stubbed out or pretended code.

Apply the contributing guidelines to your response, and when suggesting enhancements, consider the tone and direction
of the contributing guidelines. Prioritize changes that deliver user value and maintain the integrity
of the codebase's primary purpose.

Do as much as you can all at once.

Follow the linting guidelines and the formatting guidelines from the included config.


You must only add, remove, or change the files in the target writable locations. You can update multiple
files by specifying their paths and contents in the enumerated updatedFile01Filepath updatedFile02Contents response
attribute, a second file would use updatedFile01Filepath updatedFile02Contents and so on to 16. Each file will
be checked against the write permission in the Agent configuration file before being written. Feel free to
add new files as long as they are in the target writable locations. You can also remove files, but only if
they are in the target writable locations. To delete a file, set the updated file contents to "delete".

The target writable locations for your output are: SOURCES.md;library/;features/;tests/unit/plot-generation.test.js;src/lib/main.js;package.json;USAGE.md;README.md
Other file will be supplied in the context but only the paths above should be written to.

Only provide new or updated content for the target source files in src/lib/main.js.
Only delete or update the target source files in src/lib/main.js.
Only provide new or updated content for the target test files in tests/unit/plot-generation.test.js.
Only delete or update the target test files in tests/unit/plot-generation.test.js.
Only update dependency file package.json.
Only update the target documentation files in USAGE.md.

Follow the attached Formatting file content and Linting file content.

Consider the following when refining your response:
* Current feature names and specifications in the repository
* Source file content
* Test file content
* Documentation file content
* README file content
* MISSION file content
* Contributing file content
* Dependencies file content
* Formatting file content
* Linting file content
* Agent configuration file content
* Issue details
* Dependency list
* Build output
* Test output
* Main execution output

Current feature names and specifications (for context, read only):
CURRENT_FEATURES_START
features/OUTPUT_FORMATS.md
# features/OUTPUT_FORMATS.md
# Overview
Extend the CLI tool and add an HTTP server mode to support multiple output formats: svg, png, json, and csv. Provide a consistent interface across both CLI and HTTP modes, enabling users to export vector or raster images, raw data, or tabular outputs for integration with external workflows.

# CLI Integration
- Add flag --format <format> with allowed values svg, png, json, csv. Default svg.
- Retain existing flags --expression, --range, --input, --input-format, --output, and deprecate --png by mapping it to --format png.
- After parsing args, load or generate data, then branch on format:
  - svg: generate vector via generateSVG(data, options) and output XML.
  - png: invoke convertSVGtoPNG on the generated SVG and output binary.
  - json: serialize { xValues, yValues } to application/json.
  - csv: implement a generateCSV(data) helper to produce text/csv with header x,y and rows.
- Write output to stdout or to the file specified by --output, honoring absolute or relative paths.

# HTTP API
- Introduce flags --serve to enable server mode and --port <number> to specify listening port (default 3000).
- When --serve is true, spin up an Express app and register a GET /plot endpoint.
- Accept query parameters: expression, range, input, inputFormat, format, output omitted.
- Validate required parameters and return 400 with a JSON error on invalid input or missing fields.
- On success, generate the requested format and set Content-Type accordingly: image/svg+xml, image/png, application/json, or text/csv.
- Respond with data in the response body without writing to disk.

# Implementation
- Update parseArgs in src/lib/main.js to include format (enum), serve (boolean), and port (number); deprecate png alias.
- After data is loaded, pass options.width, height, margin from optional flags if provided.
- Abstract common generation logic into a helper function to reuse between CLI and HTTP.
- Use sharp for PNG conversion and Express for server.

# Tests
- Extend parseArgs tests to cover --format, --serve, --port, and deprecation of --png.
- Add unit tests for json and csv outputs in tests/unit/plot-generation.test.js:
  - Verify JSON payload structure and error on empty data.
  - Verify CSV header and rows.
- Use supertest to test HTTP API in a new tests/unit/http-api.test.js:
  - GET /plot?expression=x&range=x=0:2&format=csv returns 200 text/csv and correct CSV.
  - Test format=json returns application/json with correct body.
  - Test format=png and format=svg return correct content types and response bodies.
  - Test error responses for missing expression or bad range.

# Documentation
- Update README.md and USAGE.md to document --format, --serve, --port and HTTP examples:
    curl "http://localhost:3000/plot?expression=x&range=x=0:5:1&format=csv" > data.csv
    npx repository0-plot-code-lib --serve --port 4000
    npx repository0-plot-code-lib --expression "sin(x)" --range "x=0:3" --format png --output out.png
features/DATA_INPUT.md
# features/DATA_INPUT.md
# Overview

Add support for importing time series data from external files (JSON or CSV) to generate plots without requiring an expression and range on the command line. This enables users to visualize arbitrary datasets and integrate seamlessly with downstream workflows.

# CLI Integration

- Introduce a new flag --input <file> to specify a path to a JSON or CSV file containing time series data.
- When --input is provided:
  - expression and range flags become optional and ignored.
  - Validate file extension: .json or .csv. Report an error for unsupported formats.
  - Provide an example usage:
    npx repository0-plot-code-lib --input data.json --output plot.svg
    npx repository0-plot-code-lib --input data.csv --format png --output plot.png

# Implementation

- Extend parseArgs in src/lib/main.js to accept input (string) in the args schema.
- In main:
  - If parsed.input exists, read the file from disk with fs.readFileSync.
  - If .json:
    - JSON.parse to obtain an object with xValues (number[]) and yValues (number[]). Validate array lengths match.
  - If .csv:
    - Parse lines by splitting on newlines. Expect header row, e.g., x,y. Use built-in string methods to parse numbers.
    - Convert columns into xValues and yValues arrays. Throw an error on parse failure or mismatched lengths.
  - After data is loaded, reuse generateSVG or format logic (with --format) to produce the plot or raw data output.
  - Honor --format and --output flags as in existing flow.
  - Print clear error messages for file I/O or parsing issues and exit with non-zero status.

# Tests

- Add unit tests in tests/unit/plot-generation.test.js to cover:
  - parseArgs correctly parsing --input alongside other flags.
  - Loading JSON input: create a temporary JSON file with known arrays and verify generateSVG called with correct data.
  - Loading CSV input: create a temporary CSV file, parse it, and verify data arrays.
  - Error handling: unsupported extension, invalid JSON, malformed CSV, mismatched array lengths.
- Ensure the test suite cleans up any temp files and does not interfere with other tests.

# Documentation

- Update README.md and USAGE.md to document the new --input flag, supported formats, examples, and error conditions.
CURRENT_FEATURES_END

Source files (write new files or update files in src/lib/main.js as necessary):
(Multiple files from both in writable locations and not.)
SOURCE_FILE_START Filepath: src/lib/main.js
#!/usr/bin/env node
// src/lib/main.js

import fs from "fs";
import { fileURLToPath } from "url";
import path from "path";
import { z } from "zod";
import { create, all } from "mathjs";
import sharp from "sharp";

const math = create(all);

export function parseArgs(args) {
  const booleanFlags = ["png"];
  const argsSchema = z.object({
    expression: z.string().optional(),
    range: z.string().optional(),
    output: z.string().optional(),
    input: z.string().optional(),
    inputFormat: z.enum(["csv", "json"]).optional(),
    png: z.boolean().optional(),
  });
  const parsed = {};
  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    if (arg.startsWith("--")) {
      const key = arg.substring(2);
      if (booleanFlags.includes(key)) {
        parsed[key] = true;
      } else {
        const value = args[i + 1];
        if (value && !value.startsWith("--")) {
          parsed[key] = value;
          i++;
        } else {
          throw new Error(`Missing value for argument: ${arg}`);
        }
      }
    }
  }
  return argsSchema.parse(parsed);
}

export function parseRange(rangeStr) {
  const [varName, rangePart] = rangeStr.split("=");
  if (!varName || !rangePart) {
    throw new Error(`Invalid range format: ${rangeStr}`);
  }
  const parts = rangePart.split(":").map((p) => parseFloat(p));
  const min = parts[0];
  const max = parts[1];
  const step = parts.length >= 3 && !isNaN(parts[2]) ? parts[2] : 1;
  if (isNaN(min) || isNaN(max) || isNaN(step)) {
    throw new Error(`Invalid range numbers in: ${rangeStr}`);
  }
  return { varName, min, max, step };
}

export function generateData(expression, { varName, min, max, step }) {
  const expr = math.parse(expression).compile();
  const xValues = math.range(min, max, step, true).toArray();
  const yValues = xValues.map((x) => expr.evaluate({ [varName]: x }));
  return { xValues, yValues };
}

export function generateSVG({ xValues, yValues }, options = {}) {
  const width = options.width || 800;
  const height = options.height || 600;
  const margin = options.margin || 40;

  const minX = Math.min(...xValues);
  const maxX = Math.max(...xValues);
  const minY = Math.min(...yValues);
  const maxY = Math.max(...yValues);
  const xScale = (width - 2 * margin) / (maxX - minX || 1);
  const yScale = (height - 2 * margin) / (maxY - minY || 1);

  const points = xValues
    .map((x, i) => {
      const y = yValues[i];
      const px = margin + (x - minX) * xScale;
      const py = height - margin - (y - minY) * yScale;
      return `${px},${py}`;
    })
    .join(" ");

  const axes = [
    `<line x1="${margin}" y1="${margin}" x2="${margin}" y2="${height - margin}" stroke="black"/>`,
    `<line x1="${margin}" y1="${height - margin}" x2="${width - margin}" y2="${height - margin}" stroke="black"/>`,
  ];

  return `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
  ${axes.join("\n  ")}
  <polyline fill="none" stroke="black" stroke-width="2" points="${points}"/>
</svg>`;
}

export function parseInputFile(filePath, formatOverride) {
  const ext = path.extname(filePath).toLowerCase().slice(1);
  const format = formatOverride || ext;
  if (!["csv", "json"].includes(format)) {
    throw new Error("Unsupported input format");
  }
  const content = fs.readFileSync(filePath, "utf8");
  let xValues = [];
  let yValues = [];
  if (format === "csv") {
    const lines = content.split(/\r?\n/).filter((line) => line.trim() !== "");
    if (lines.length < 2) {
      throw new Error("CSV file must have at least a header and one data row");
    }
    const header = lines[0].split(",");
    if (header[0].trim() !== "x" || header[1].trim() !== "y") {
      throw new Error("CSV header must be 'x,y'");
    }
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      if (cols.length !== 2) throw new Error(`Invalid CSV row: ${lines[i]}`);
      const x = parseFloat(cols[0]);
      const y = parseFloat(cols[1]);
      if (isNaN(x) || isNaN(y)) throw new Error(`Invalid number in CSV at row ${i + 1}`);
      xValues.push(x);
      yValues.push(y);
    }
  } else {
    let parsedJson;
    try {
      parsedJson = JSON.parse(content);
    } catch (err) {
      throw new Error(`Invalid JSON: ${err.message}`);
    }
    if (Array.isArray(parsedJson)) {
      for (const item of parsedJson) {
        if (typeof item.x !== "number" || typeof item.y !== "number") {
          throw new Error("JSON items must have numeric 'x' and 'y' properties");
        }
        xValues.push(item.x);
        yValues.push(item.y);
      }
    } else if (parsedJson.xValues && parsedJson.yValues) {
      if (!Array.isArray(parsedJson.xValues) || !Array.isArray(parsedJson.yValues)) {
        throw new Error("JSON must have 'xValues' and 'yValues' arrays");
      }
      xValues = parsedJson.xValues;
      yValues = parsedJson.yValues;
      if (xValues.length !== yValues.length) {
        throw new Error("Mismatched data lengths");
      }
      if (!xValues.every((x) => typeof x === "number") || !yValues.every((y) => typeof y === "number")) {
        throw new Error("JSON arrays must contain numbers");
      }
    } else {
      throw new Error("JSON must be an array of {x,y} or an object with xValues and yValues");
    }
  }
  if (xValues.length !== yValues.length) {
    throw new Error("Mismatched data lengths");
  }
  return { xValues, yValues };
}

export async function convertSVGtoPNG(svg) {
  return sharp(Buffer.from(svg)).png().toBuffer();
}

export async function main(argsParam) {
  const args = argsParam ?? process.argv.slice(2);
  if (!args || args.length === 0) {
    console.log(`Run with: ${JSON.stringify(args)}`);
    return;
  }
  let parsed;
  try {
    parsed = parseArgs(args);
  } catch (err) {
    console.error(err.message);
    process.exit(1);
  }
  let data;
  if (parsed.input) {
    try {
      data = parseInputFile(parsed.input, parsed.inputFormat);
    } catch (err) {
      console.error(err.message);
      process.exit(1);
    }
  } else {
    let rangeObj;
    try {
      rangeObj = parseRange(parsed.range);
    } catch (err) {
      console.error(err.message);
      process.exit(1);
    }
    try {
      data = generateData(parsed.expression, rangeObj);
    } catch (err) {
      console.error(`Error evaluating expression: ${err.message}`);
      process.exit(1);
    }
  }
  const svg = generateSVG(data);
  if (parsed.png) {
    try {
      const buffer = await convertSVGtoPNG(svg);
      if (parsed.output) {
        const outPath = path.isAbsolute(parsed.output)
          ? parsed.output
          : path.resolve(process.cwd(), parsed.output);
        fs.writeFileSync(outPath, buffer);
      } else {
        process.stdout.write(buffer);
      }
    } catch (err) {
      console.error(`Error generating PNG: ${err.message}`);
      process.exit(1);
    }
  } else {
    if (parsed.output) {
      try {
        const outPath = path.isAbsolute(parsed.output)
          ? parsed.output
          : path.resolve(process.cwd(), parsed.output);
        fs.writeFileSync(outPath, svg, "utf8");
      } catch (err) {
        console.error(`Error writing file: ${err.message}`);
        process.exit(1);
      }
    } else {
      console.log(svg);
    }
  }
}

if (process.argv[1] === fileURLToPath(import.meta.url)) {
  main(process.argv.slice(2));
}

SOURCE_FILE_END



Test files (write new files or update files in tests/unit/plot-generation.test.js as necessary):
(Multiple files from both in writable locations and not.)
TEST_FILE_START File: tests/unit/plot-generation.test.js
import { describe, test, expect } from "vitest";
import fs from "fs";
import os from "os";
import path from "path";
import {
  parseArgs,
  parseRange,
  generateData,
  generateSVG,
  main,
  parseInputFile,
  convertSVGtoPNG,
} from "@src/lib/main.js";

describe("Main Module Import", () => {
  test("should be non-null", () => {
    expect({ parseArgs, parseRange, generateData, generateSVG, main }).not.toBeNull();
  });
});

describe("parseArgs", () => {
  test("should parse valid CLI args", () => {
    const args = [
      "--expression",
      "x*2",
      "--range",
      "x=0:5:2",
      "--output",
      "out.svg",
    ];
    const parsed = parseArgs(args);
    expect(parsed).toEqual({
      expression: "x*2",
      range: "x=0:5:2",
      output: "out.svg",
    });
  });
});

describe("parseRange", () => {
  test("should parse range string", () => {
    const range = "x=0:5:2";
    const result = parseRange(range);
    expect(result).toEqual({ varName: "x", min: 0, max: 5, step: 2 });
  });
  test("should default step to 1", () => {
    const range = "x=1:3";
    const result = parseRange(range);
    expect(result).toEqual({ varName: "x", min: 1, max: 3, step: 1 });
  });
});

describe("generateData", () => {
  test("should generate data points", () => {
    const exp = "x*2";
    const rangeObj = { varName: "x", min: 0, max: 4, step: 2 };
    const data = generateData(exp, rangeObj);
    expect(data.xValues).toEqual([0, 2, 4]);
    expect(data.yValues).toEqual([0, 4, 8]);
  });
});

describe("generateSVG", () => {
  test("should generate SVG with expected tags and points", () => {
    const data = { xValues: [0, 1], yValues: [0, 2] };
    const svg = generateSVG(data, { width: 100, height: 50, margin: 5 });
    expect(svg).toContain('<svg');
    expect(svg).toContain('xmlns="http://www.w3.org/2000/svg"');
    expect(svg).toContain('<polyline');
    expect(svg).toMatch(/points="[^"]+"/);
  });
});

describe("Default main", () => {
  test("should terminate without error on no args", () => {
    process.argv = ["node", "src/lib/main.js"];
    expect(() => main()).not.toThrow();
  });
});

describe("parseInputFile", () => {
  test("should parse CSV input file", () => {
    const tmp = path.join(os.tmpdir(), "test-input.csv");
    fs.writeFileSync(tmp, "x,y\n1,2\n3,4\n");
    const data = parseInputFile(tmp);
    expect(data).toEqual({ xValues: [1, 3], yValues: [2, 4] });
    fs.unlinkSync(tmp);
  });

  test("should parse JSON input file with object array", () => {
    const tmp = path.join(os.tmpdir(), "test-input.json");
    const arr = [{ x: 0, y: 1 }, { x: 2, y: 3 }];
    fs.writeFileSync(tmp, JSON.stringify(arr));
    const data = parseInputFile(tmp);
    expect(data).toEqual({ xValues: [0, 2], yValues: [1, 3] });
    fs.unlinkSync(tmp);
  });

  test("should throw on unsupported format", () => {
    const tmp = path.join(os.tmpdir(), "test-input.txt");
    fs.writeFileSync(tmp, "foo");
    expect(() => parseInputFile(tmp)).toThrow("Unsupported input format");
    fs.unlinkSync(tmp);
  });
});

describe("convertSVGtoPNG", () => {
  test("should convert SVG to PNG buffer", async () => {
    const svg = '<svg xmlns="http://www.w3.org/2000/svg"><rect width="10" height="10"/></svg>';
    const buffer = await convertSVGtoPNG(svg);
    expect(buffer.slice(0, 8)).toEqual(Buffer.from([0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a]));
  });
});
TEST_FILE_END


TEST_FILE_START File: tests/unit/main.test.js
import { describe, test, expect } from "vitest";
import * as mainModule from "@src/lib/main.js";
import { main } from "@src/lib/main.js";

describe("Main Module Import", () => {
  test("should be non-null", () => {
    expect(mainModule).not.toBeNull();
  });
});

describe("Default main", () => {
  test("should terminate without error", () => {
    process.argv = ["node", "src/lib/main.js"];
    main();
  });
});

TEST_FILE_END



Documentation files (write new files or update files in USAGE.md as necessary):
(Multiple files from both in writable locations and not.)
DOCUMENTATION_FILE_START File: USAGE.md
# Usage

To generate an SVG plot from a mathematical expression:

```bash
npx repository0-plot-code-lib --expression "sin(x)" --range "x=0:6.28:0.1" --output output.svg
```

Options:

- `--expression <expr>`: A mathematical expression in variable `x`. Required unless using `--input`.
- `--range <range>`: Range for `x` in the format `x=min:max[:step]`. Required unless using `--input`. `step` defaults to `1`.
- `--output <file>`: Output file path for the image or SVG. Optional. Defaults to stdout.
- `--input <file>`: Path to a CSV or JSON file containing time series data. When provided, `--expression` and `--range` are ignored.
- `--input-format <csv|json>`: Override input format detection based on file extension. Optional.
- `--png`: Output a PNG image instead of SVG. When used without `--output`, the PNG binary is written to stdout.

Examples:

Generate SVG from CSV data:
```bash
npx repository0-plot-code-lib --input data.csv --output plot.svg
```

Generate PNG from CSV data:
```bash
npx repository0-plot-code-lib --input data.csv --png --output plot.png
```

Generate PNG from JSON data, writing to stdout:
```bash
npx repository0-plot-code-lib --input data.json --input-format json --png > out.png
```

You can still use the expression/range syntax for SVG:
```bash
npx repository0-plot-code-lib --expression "x^2" --range "x=0:10:0.5" > plot.svg
```
DOCUMENTATION_FILE_END



README file (for context, read only): README.md
README_FILE_START
# repository0-plot-code-lib

"Be a go-to plot library with a CLI, be the jq of formulae visualisations."

## Installation

Install via npm:

```bash
npm install @xn-intenton-z2a/repository0-plot-code-lib
```

Or use npx without installing:

```bash
npx repository0-plot-code-lib --expression "sin(x)" --range "x=0:6.28:0.1"
```

## Usage

Run the CLI with the following syntax:

```bash
npx repository0-plot-code-lib --expression "<expr>" --range "<range>" [--output "<file>"]
```

Options:

- `--expression <expr>` (required): A mathematical expression in variable `x`.
- `--range <range>` (required): Range for `x` in the format `x=min:max[:step]`. Step defaults to `1`.
- `--output <file>` (optional): Path to save the output. Defaults to stdout.
- `--input <file>` (optional): Path to a CSV or JSON file containing data (ignores expression and range).
- `--input-format <csv|json>` (optional): Override input format detection.
- `--png` (optional): Output a PNG image instead of SVG.

## Examples

Generate an SVG plot and save to a file:

```bash
npx repository0-plot-code-lib --expression "sin(x)" --range "x=0:6.28:0.1" --output output.svg
```

Redirect output to STDOUT and pipe to a file:

```bash
npx repository0-plot-code-lib --expression "x^2" --range "x=0:10:0.5" > plot.svg
```

## License

MIT

README_FILE_END

MISSION file (for context, read only): MISSION.md
MISSION_FILE_START
# Mission Statement

_"Be a go-to plot library with a CLI, be the jq of formulae visualisations."_

**plot-code-lib** is a JavaScript library and CLI tool designed to:
- Transform and given range and a simple expression syntax for (pick an existing open standard) to time series data.
- Read and write the time series data in a standard format (pick an existing open standard).
- Make use of libraries for formula parsing, time series generation, plotting, and persistence in image formats.
- Generate SVG and PNG plots from the time series data and save these as files.
- Variations on this example: `node run start -- --expression "y=sin(x)" --range "x=-1:-1,y=-1:-1" --file output.svg` .
- Showcase all the features of the library via a CLI by dry running tp generate example commands and output in the README.md file.

`plot-code-lib` facilitate the creation of plots from mathematical expressions and time series data. It will take a
mathematical expression and a range of values and generate a plot in SVG or PNG format.

MISSION_FILE_END

Contributing file (for context, read only): CONTRIBUTING.md
CONTRIBUTING_FILE_START
# repository0-plot-code-lib

_"Be a go-to plot library with a CLI, be the jq of formulae visualisations."_

## How to Contribute

The guidelines below apply to human or automated contributions:

1. **Report Issues or Ideas:**
    - Open an issue on GitHub to share bug reports, feature requests, or any improvements you envision.
    - Clear descriptions and reproducible steps are highly appreciated.

2. **Submit Pull Requests:**
    - Fork the repository and create a feature branch.
    - Implement your changes, ensuring you follow the existing coding style and standards.
    - Add tests to cover any new functionality.
    - Update documentation if your changes affect usage or workflow behavior.
    - Submit your pull request for review.

## Guidelines

- **Code Quality:**
    - Ensure there are tests that cover your changes and any likely new cases they introduce.
    - When making a change remain consistent with the existing code style and structure.
    - When adding new functionality, consider if some unused or superseded code should be removed.

- **Compatibility:**
    - Ensure your code runs on Node 20 and adheres to ECMAScript Module (ESM) standards.
    - Tests use vitest and competing test frameworks should not be added.
    - Mocks in tests must not interfere with other tests.

- **Testing:**
    - The command `npm test` should invoke the tests added for the new functionality (and pass).
    - If you add new functionality, ensure it is covered by tests.

- **Documentation:**
    - When making a change to the main source file, review the readme to see if it needs to be updated and if so, update it.
    - Where the source exports a function, consider that part of the API of the library and document it in the readme.
    - Where the source stands-up an HTTP endpoint, consider that part of the API of the library and document it in the readme.
    - Include usage examples including inline code usage and CLI and HTTP invocation, API references.

CONTRIBUTING_FILE_END

Dependencies file (for context, read only): package.json
DEPENDENCIES_FILE_START
{
  "name": "@xn-intenton-z2a/repository0-plot-code-lib",
  "version": "1.2.0-0",
  "description": "Be a go-to plot library with a CLI, be the jq of formulae visualisations.",
  "type": "module",
  "main": "src/lib/main.js",
  "bin": {
    "repository0-plot-code-lib": "src/lib/main.js"
  },
  "scripts": {
    "build": "echo 'Nothing to build'",
    "formatting": "prettier --check .",
    "formatting-fix": "prettier --write .",
    "linting": "eslint .",
    "linting-json": "eslint --format=@microsoft/eslint-formatter-sarif .",
    "linting-fix": "eslint --fix .",
    "update-to-minor": "npx npm-check-updates --upgrade --enginesNode --target minor --verbose --install always",
    "update-to-greatest": "npx npm-check-updates --upgrade --enginesNode --target greatest --verbose --install always --reject 'alpha'",
    "test": "vitest tests/unit/*.test.js",
    "test:unit": "vitest --coverage tests/unit/*.test.js",
    "start": "node src/lib/main.js"
  },
  "keywords": [
    "csv",
    "json",
    "png"
  ],
  "author": "",
  "license": "MIT",
  "dependencies": {
    "dotenv": "^16.5.0",
    "ejs": "^3.1.10",
    "js-yaml": "^4.1.0",
    "mathjs": "^11.8.2",
    "minimatch": "^10.0.1",
    "openai": "^4.95.1",
    "sharp": "^0.32.4",
    "zod": "^3.24.4"
  },
  "devDependencies": {
    "@microsoft/eslint-formatter-sarif": "^3.1.0",
    "@vitest/coverage-v8": "^3.1.3",
    "eslint": "^9.25.1",
    "eslint-config-google": "^0.14.0",
    "eslint-config-prettier": "^10.1.5",
    "eslint-plugin-import": "^2.31.0",
    "eslint-plugin-prettier": "^5.2.6",
    "eslint-plugin-promise": "^7.2.1",
    "eslint-plugin-react": "^7.37.5",
    "eslint-plugin-security": "^3.0.1",
    "eslint-plugin-sonarjs": "^3.0.2",
    "express": "^4.21.2",
    "js-yaml": "^4.1.0",
    "markdown-it-github": "^0.5.0",
    "markdown-it": "^14.1.0",
    "npm-check-updates": "^17.1.18",
    "prettier": "^3.5.3",
    "vitest": "^3.1.3"
  },
  "engines": {
    "node": ">=20.0.0"
  },
  "files": [
    "src/"
  ],
  "publishConfig": {
    "registry": "https://npm.pkg.github.com"
  }
}

DEPENDENCIES_FILE_END

Formatting file (for context, read only): .prettierrc
FORMATTING_FILE_START
{
  "singleQuote": false,
  "trailingComma": "all",
  "printWidth": 120,
  "tabWidth": 2,
  "useTabs": false,
  "quoteProps": "consistent",
  "overrides": [
    {
      "files": ".prettierrc",
      "options": { "parser": "json" }
    }
  ]
}

FORMATTING_FILE_END

Linting file (for context, read only): eslint.config.js
LINTING_FILE_START
import js from "@eslint/js";
import google from "eslint-config-google";
import eslintPluginPrettierRecommended from "eslint-plugin-prettier/recommended";
import globals from "globals";
import promise from "eslint-plugin-promise";
import security from "eslint-plugin-security";
import sonarjs from "eslint-plugin-sonarjs";
import react from "eslint-plugin-react";
import importPlugin from "eslint-plugin-import";

const modifiedGoogleConfig = { ...google, rules: { ...google.rules } };
delete modifiedGoogleConfig.rules["valid-jsdoc"];
delete modifiedGoogleConfig.rules["require-jsdoc"];

/** @type {import('eslint').Linter.FlatConfig[]} */
export default [
  js.configs.recommended,
  modifiedGoogleConfig,
  eslintPluginPrettierRecommended,
  {
    plugins: {
      promise,
      security,
      sonarjs,
      react,
      import: importPlugin,
    },
    languageOptions: {
      ecmaVersion: 2023,
      sourceType: "module",
      globals: {
        ...globals.node,
      },
    },
    rules: {
      "prettier/prettier": "error",
      ...promise.configs.recommended.rules,
      ...sonarjs.configs.recommended.rules,
      "sonarjs/os-command": "off",

      // Formatting and organisation
      "no-unused-vars": ["error", { argsIgnorePattern: "^_" }],
      "no-extra-semi": 2,
      "object-curly-newline": ["error", { consistent: true }],
      "array-element-newline": ["error", "consistent", { multiline: true, minItems: 10 }],
      "import/newline-after-import": ["error", { count: 1 }],
      "camelcase": "off",

      // ESM import rules
      "import/no-amd": "error",
      "import/no-commonjs": "error",
      "import/no-import-module-exports": "error",
      "import/no-cycle": "error",
      "import/no-dynamic-require": "error",
      "import/no-self-import": "off",
      "import/no-unresolved": "off",
      "import/no-useless-path-segments": "error",
      "import/no-duplicates": "error",
      "sonarjs/fixme-tag": "warn",
    },
  },
  {
    files: ["**/*.js"],
    ignores: ["**/tests/**/*.js", "**/*.test.js", "eslint.config.js"],
    rules: {
      ...security.configs.recommended.rules,
      "security/detect-non-literal-fs-filename": "off",
      "security/detect-non-literal-regexp": "off",
      "security/detect-object-injection": "off",
    },
  },
  {
    settings: {
      react: {
        version: "18",
      },
    },
  },
  {
    ignores: ["build/", "coverage/", "dist/", "exports/", "node_modules/", "eslint.config.js"],
  },
];

LINTING_FILE_END

Agent configuration file (for context, read only):
AGENT_CONFIG_FILE_START
# Which agentic-lib workflow schedule should be used?
schedule: schedule-2

# Mapping for from symbolic keys to filepaths for access by agentic-lib workflows with limits and access permissions
paths:
  # Filepaths for elaborator workflows
  missionFilepath:
    path: 'MISSION.md'
  librarySourcesFilepath:
    path: 'SOURCES.md'
    permissions: [ 'write' ]
    limit: 16
  libraryDocumentsPath:
    path: 'library/'
    permissions: [ 'write' ]
    limit: 32
  featuresPath:
    path: 'features/'
    permissions: [ 'write' ]
    limit: 2

  # Filepaths for engineer workflows
  contributingFilepath:
    path: 'CONTRIBUTING.md'
  targetTestsPath:
    path: 'tests/unit/plot-generation.test.js'
    permissions: [ 'write' ]
  otherTestsPaths:
    paths: [ 'tests/unit/main.test.js' ]
  targetSourcePath:
    path: 'src/lib/main.js'
    permissions: [ 'write' ]
  otherSourcePaths:
    paths: [ 'src/lib/' ]
  dependenciesFilepath:
    path: 'package.json'
    permissions: [ 'write' ]
  documentationPath:
    path: 'USAGE.md'
    permissions: [ 'write' ]

  # Filepaths for maintainer workflows
  formattingFilepath:
    path: '.prettierrc'
  lintingFilepath:
    path: 'eslint.config.js'
  readmeFilepath:
    path: 'README.md'
    permissions: [ 'write' ]

# Execution commands
buildScript: "npm run build"
testScript: "npm test"
mainScript: "npm run start"

# How many issues should be open to be picked up?
featureDevelopmentIssuesWipLimit: 2
maintenanceIssuesWipLimit: 1

# How many attempts should be made to work on an issue?
attemptsPerBranch: 2
attemptsPerIssue: 2

# Web publishing
docRoot: 'public'

# Repository seeding
seeding:
  repositoryReseed: 'true'
  missionFilepath: 'seeds/zero-MISSION.md'
  sourcePath: 'seeds/zero-main.js'
  testsPath: 'seeds/zero-tests.js'
  dependenciesFilepath: 'seeds/zero-package.json'
  readmeFilepath: 'seeds/zero-README.md'

# The intention is associated with the bot's discussion thread.
intentionBot:
  intentionFilepath: 'intentïon.md'

AGENT_CONFIG_FILE_END

Issue details:
ISSUE_START
title: Implement OUTPUT_FORMATS feature and HTTP server mode (SVG, PNG, JSON, CSV)
description:
Title: Implement OUTPUT_FORMATS feature and HTTP server mode (SVG, PNG, JSON, CSV)

Description:
Extend the existing CLI tool to support multiple output formats and add an HTTP server mode. Replace the deprecated --png flag with a unified --format flag, implement JSON and CSV output, and expose a GET /plot HTTP endpoint.

Testable Acceptance Criteria:

1. CLI Flag Parsing:
   - New flag `--format <svg|png|json|csv>` is supported, defaulting to `svg`.
   - The existing `--png` flag is treated as an alias for `--format=png` (with a deprecation warning).
   - New flags `--serve` (boolean) and `--port <number>` (default 3000) are parsed correctly.
   - Unit tests for `parseArgs` cover valid and invalid combinations of `--format`, `--png`, `--serve`, and `--port`.

2. Output Generation Functions:
   - Implement `generateCSV(data)` that returns a string with header `"x,y"` and one row per data point.
     - Throws an error if `xValues` or `yValues` are empty or lengths mismatch.
   - JSON output: serializes data to `{ xValues: [...], yValues: [...] }`.
   - Unit tests verify:
     - Correct CSV string for sample data.
     - Errors on invalid CSV input.
     - JSON output matches expected structure and values.

3. CLI Output Behavior:
   - For `--format=svg`, call `generateSVG` and output XML to stdout or file.
   - For `--format=png`, call `generateSVG` then `convertSVGtoPNG` and output binary to stdout or file.
   - For `--format=json`, output JSON text to stdout or file.
   - For `--format=csv`, output CSV text to stdout or file.
   - Tests for each format confirm correct content, content type, and file creation.

4. HTTP Server Mode:
   - When `--serve` is passed, start an Express server on the specified port.
   - Register `GET /plot` endpoint accepting query parameters: `expression`, `range`, `input`, `inputFormat`, and `format`.
   - On valid requests, respond with HTTP 200, correct `Content-Type` header (`image/svg+xml`, `image/png`, `application/json`, or `text/csv`), and appropriate payload.
   - On missing or invalid parameters, respond with HTTP 400 and JSON body `{ error: <message> }`.
   - Integration tests using `supertest` cover:
     - Successful responses for each format.
     - Error responses for missing/invalid parameters.

5. Documentation Updates:
   - Update `README.md` and `USAGE.md` to document the `--format`, `--serve`, and `--port` flags and deprecation of `--png`.
   - Provide CLI and HTTP examples for JSON and CSV outputs.

6. Dependencies:
   - Add `supertest` to `devDependencies` for HTTP integration tests.
   - No other dependencies should be added or removed.

Verification:
- Run `npm test` and ensure all unit and integration tests pass.
- Manual verification: CLI examples produce expected outputs; HTTP server returns correct content types and data.

Maintains backward compatibility with existing expression/range and `--input` file functionality.
comments:
Author:github-actions[bot], Created:2025-05-18T04:59:25Z, Comment: Workflow name: flow-feature-maintenance
Workflow run URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/actions/runs/15092504483
Workflow event: schedule
Workflow inputs: null
HEAD of main URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/commit/5489f471afdff5ed77543606259482ede760f368
Author:github-actions[bot], Created:2025-05-18T05:00:20Z, Comment: This issue has been reviewed and marked as 'ready'. The description has been updated with testable acceptance criteria, and relevant library documents ([], 0 in total) have been added as comments.
Author:github-actions[bot], Created:2025-05-18T08:16:15Z, Comment: Workflow name: discussions-bot
Workflow run URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/actions/runs/15093916836
Workflow event: schedule
Workflow inputs: null
HEAD of main URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/commit/c08eaf7701decf2b80ffa276959394d717235ff0
Author:github-actions[bot], Created:2025-05-18T08:17:14Z, Comment: ## Relevant Library Document: EXPRESS_API.md

Table of Contents
1. express() Initialization
2. Built-in Middleware
   2.1 json(options)
   2.2 raw(options)
   2.3 text(options)
   2.4 urlencoded(options)
3. Router Creation
4. Static File Serving
5. Application Methods
6. Application Settings

1. express() Initialization
Signature: var express = require('express'); var app = express();
Creates an Express application function that handles requests.

2. Built-in Middleware
2.1 json(options)
Signature: express.json({inflate:boolean=true, limit:number|string='100kb', reviver:Function|null=null, strict:boolean=true, type:string|string[]|Function='application/json', verify:Function|undefined});
- Parses JSON bodies matching Content-Type. Populates req.body Object or {}.
- gzip/deflate inflation enabled. verify(req,res,buf,encoding) may throw to abort.

2.2 raw(options)
Signature: express.raw({inflate:boolean=true, limit:number|string='100kb', type:string|string[]|Function='application/octet-stream', verify:Function|undefined});
- Populates req.body Buffer. validate Buffer before use.

2.3 text(options)
Signature: express.text({defaultCharset:string='utf-8', inflate:boolean=true, limit:number|string='100kb', type:string|string[]|Function='text/plain', verify:Function|undefined});
- Populates req.body string.

2.4 urlencoded(options)
Signature: express.urlencoded({extended:boolean=true, inflate:boolean=true, limit:number|string='100kb', parameterLimit:number=1000, type:string|string[]|Function='application/x-www-form-urlencoded', verify:Function|undefined});
- Populates req.body Object. extended=false uses querystring, true uses qs.

3. Router Creation
Signature: express.Router({caseSensitive:boolean=false, mergeParams:boolean=false, strict:boolean=false});
- Returns router for grouping routes and middleware.

4. Static File Serving
Signature: express.static(root:string, {dotfiles:'allow'|'deny'|'ignore'=undefined, etag:boolean=true, extensions:string[]|false=false, fallthrough:boolean=true, immutable:boolean=false, index:string|string[]|false='index.html', lastModified:boolean=true, maxAge:number|string=0, redirect:boolean=true, setHeaders:function(res,path,stat)});
- Combines req.url with root to locate file. Errors fallthrough or sent.
- dotfiles: allow/deny/ignore. fallthrough: true calls next(); false next(err).
- setHeaders(res,path,stat) sets headers synchronously.

5. Application Methods
app.METHOD(path, ...callbacks)
- path: string|RegExp|Array; callbacks: middleware functions. Returns app.
app.all(path, ...)
app.use([path], middleware)
app.param(name|string[] , callback(req,res,next,value,name))
app.engine(ext, callback(path, options, cb))
app.listen([port[, host[, backlog]]], [callback]) => http.Server
app.set(name, value), app.get(name)
app.enable(name), app.disable(name), app.enabled(name), app.disabled(name)

6. Application Settings
case sensitive routing: undefined
env: process.env.NODE_ENV||'development'
etag: 'weak'
jsonp callback name: 'callback'
json escape: undefined
json replacer: undefined
json spaces: undefined
query parser: 'extended'
strict routing: undefined
subdomain offset: 2
trust proxy: false
views: process.cwd() + '/views'
view cache: NODE_ENV==='production'
Author:github-actions[bot], Created:2025-05-18T08:17:14Z, Comment: This issue has been reviewed and marked as 'ready'. The description has been updated with testable acceptance criteria, and relevant library documents ([EXPRESS_API.md], 1 in total) have been added as comments.
Author:github-actions[bot], Created:2025-05-18T08:25:21Z, Comment: Workflow name: flow-feature-development
Workflow run URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/actions/runs/15094027740
Workflow event: schedule
Workflow inputs: null
HEAD of main URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/commit/c08eaf7701decf2b80ffa276959394d717235ff0
Author:github-actions[bot], Created:2025-05-18T08:25:46Z, Comment: Workflow name: flow-feature-development
Workflow run URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/actions/runs/15094027740
Workflow event: schedule
Workflow inputs: null
HEAD of main URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/commit/c08eaf7701decf2b80ffa276959394d717235ff0
Author:github-actions[bot], Created:2025-05-18T08:26:58Z, Comment: Workflow name: flow-feature-development
Workflow run URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/actions/runs/15094027740
Workflow event: schedule
Workflow inputs: null
HEAD of main URL: https://github.com/xn-intenton-z2a/repository0-plot-code-lib/commit/c08eaf7701decf2b80ffa276959394d717235ff0
ISSUE_END            

Dependencies list from command: npm list
DEPENDENCIES_LIST_START
@xn-intenton-z2a/repository0-plot-code-lib@1.2.0-0 /home/runner/work/repository0-plot-code-lib/repository0-plot-code-lib
├── @microsoft/eslint-formatter-sarif@3.1.0
├── @vitest/coverage-v8@3.1.3
├── dotenv@16.5.0
├── ejs@3.1.10
├── eslint-config-google@0.14.0
├── eslint-config-prettier@10.1.5
├── eslint-plugin-import@2.31.0
├── eslint-plugin-prettier@5.4.0
├── eslint-plugin-promise@7.2.1
├── eslint-plugin-react@7.37.5
├── eslint-plugin-security@3.0.1
├── eslint-plugin-sonarjs@3.0.2
├── eslint@9.27.0
├── express@4.21.2
├── js-yaml@4.1.0
├── markdown-it-github@0.5.0
├── markdown-it@14.1.0
├── mathjs@11.12.0
├── minimatch@10.0.1
├── npm-check-updates@17.1.18
├── openai@4.100.0
├── prettier@3.5.3
├── sharp@0.32.6
├── vitest@3.1.3
└── zod@3.24.4
DEPENDENCIES_LIST_END    

Build output from command: npm run build
BUILD_OUTPUT_START

> @xn-intenton-z2a/repository0-plot-code-lib@1.2.0-0 build
> echo 'Nothing to build'

Nothing to build
BUILD_OUTPUT_END      

Test output from command: npm test
TEST_OUTPUT_START

> @xn-intenton-z2a/repository0-plot-code-lib@1.2.0-0 test
> vitest tests/unit/*.test.js


[1m[46m RUN [49m[22m [36mv3.1.3 [39m[90m/home/runner/work/repository0-plot-code-lib/repository0-plot-code-lib[39m

 [32m✓[39m tests/unit/module-index.test.js [2m([22m[2m1 test[22m[2m)[22m[32m 3[2mms[22m[39m
[90mstdout[2m | tests/unit/main.test.js[2m > [22m[2mDefault main[2m > [22m[2mshould terminate without error
[22m[39mRun with: []

 [32m✓[39m tests/unit/main.test.js [2m([22m[2m2 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstdout[2m | tests/unit/plot-generation.test.js[2m > [22m[2mDefault main[2m > [22m[2mshould terminate without error on no args
[22m[39mRun with: []

 [32m✓[39m tests/unit/plot-generation.test.js [2m([22m[2m11 tests[22m[2m)[22m[32m 70[2mms[22m[39m

[2m Test Files [22m [1m[32m3 passed[39m[22m[90m (3)[39m
[2m      Tests [22m [1m[32m14 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 08:28:26
[2m   Duration [22m 1.25s[2m (transform 73ms, setup 0ms, collect 1.94s, tests 77ms, environment 1ms, prepare 262ms)[22m
TEST_OUTPUT_END            

Main execution output from command: npm run start
MAIN_OUTPUT_START

> @xn-intenton-z2a/repository0-plot-code-lib@1.2.0-0 start
> node src/lib/main.js

Run with: []
MAIN_OUTPUT_END    

Please produce updated versions of the files that resolve the issue.
Note that the README.md file is provided for context only - any documentation changes should be written to the documentation files.
The source files, test files, and documentation files can be individual files or directories containing multiple files.
Never truncate the files, when returning a file, always return the entire file content.

Paths in (updatedFile01Filepath, updatedFile02Filepath, etc...) must begin with one of: SOURCES.md;library/;features/;tests/unit/plot-generation.test.js;src/lib/main.js;package.json;USAGE.md;README.md

Answer strictly with a JSON object following this schema:
{
  "message": "A short sentence explaining the change applied (or why no changes were applied) suitable for a commit message or PR text.",
  "updatedFile01Filepath": "src/lib/main.js/orderParser.js",
  "updatedFile01Contents": "The entire new content of the source file, with all necessary changes applied, if any.",
  "updatedFile02Filepath":  "tests/unit/plot-generation.test.js/orderParser.test.js",
  "updatedFile02Contents": "The entire new content of the test file, with all necessary changes applied, if any.",
  "updatedFile03Filepath": "USAGE.md/USAGE.md",
  "updatedFile03Contents": "The entire new content of the documentation file, with all necessary changes applied, if any.",
  "updatedFile04Filepath": "USAGE.md/A_FILE_WE_DONT_WANT.md",
  "updatedFile04Contents": "delete",
  "updatedFile05Filepath": "unused",
  "updatedFile05Contents": "unused",
  "updatedFile06Filepath": "unused",
  "updatedFile06Contents": "unused",
  "updatedFile07Filepath": "unused",
  "updatedFile07Contents": "unused",
  "updatedFile08Filepath": "unused",
  "updatedFile08Contents": "unused",
  "updatedFile09Filepath": "unused",
  "updatedFile09Contents": "unused",
  "updatedFile10Filepath": "unused",
  "updatedFile10Contents": "unused",
  "updatedFile11Filepath": "unused",
  "updatedFile11Contents": "unused",
  "updatedFile12Filepath": "unused",
  "updatedFile12Contents": "unused",
  "updatedFile13Filepath": "unused",
  "updatedFile13Contents": "unused",
  "updatedFile14Filepath": "unused",
  "updatedFile14Contents": "unused",
  "updatedFile15Filepath": "unused",
  "updatedFile15Contents": "unused",
  "updatedFile16Filepath": "unused",
  "updatedFile16Contents": "unused"
}

You can include up to 16 files using the updatedFileXXName and updatedFileXXContents pairs (where XX is a number from 01 to 16)
Where a file name and contents slot is not used, populate tha name with "unused" and the contents with "unused".
Where a file is to be deleted, set the name to the file path and the contents to "delete".
Never truncate the files, when returning a file, always return the entire file content.

Ensure valid JSON.
